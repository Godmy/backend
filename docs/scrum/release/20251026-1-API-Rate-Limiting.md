# 20251026-1-API-Rate-Limiting

## Описание Релиза

Реализовано ограничение частоты запросов (Rate Limiting) для защиты API от злоупотреблений и DDoS-атак.

**User Story:**
Как администратор системы, я хочу ограничить количество запросов от одного пользователя, чтобы защититься от abuse и DDoS.

**Acceptance Criteria:**
- Rate limiting per user/IP
- Лимиты: 100 req/min для auth users, 20 req/min для anon
- Redis для хранения счетчиков
- Headers: `X-RateLimit-Limit`, `X-RateLimit-Remaining`, `X-RateLimit-Reset`
- HTTP 429 Too Many Requests при превышении
- Whitelist для admin/internal IPs

## Атомы (Задачи/Изменения)

*   **[US-API-RL-001]** Реализован `RateLimitMiddleware` с использованием Redis и алгоритма скользящего окна.
    *   *Описание:* Внедрен механизм ограничения запросов на основе IP-адреса и ID пользователя.
    *   *Ссылка на бэклог:* (Предполагаемая ссылка на задачу в Jira/GitHub)
*   **[US-API-RL-002]** Настроены конфигурируемые лимиты для аутентифицированных и анонимных пользователей.
    *   *Описание:* Добавлены параметры `RATE_LIMIT_AUTH_PER_MINUTE` и `RATE_LIMIT_ANON_PER_MINUTE`.
*   **[US-API-RL-003]** Добавлены HTTP-заголовки `X-RateLimit-Limit`, `X-RateLimit-Remaining`, `X-RateLimit-Reset`.
    *   *Описание:* Предоставление информации о текущем состоянии лимитов клиентам.
*   **[US-API-RL-004]** Обработка превышения лимита с ответом HTTP 429 Too Many Requests.
    *   *Описание:* В случае превышения лимита возвращается статус 429 с заголовком `Retry-After`.
*   **[US-API-RL-005]** Реализован белый список IP-адресов.
    *   *Описание:* IP-адреса из `RATE_LIMIT_WHITELIST_IPS` исключаются из проверки лимитов.
*   **[US-API-RL-006]** Добавлены исключения для определенных путей API.
    *   *Описание:* Пути, указанные в `RATE_LIMIT_EXCLUDE_PATHS`, не подвергаются проверке лимитов.
*   **[US-API-RL-007]** Интегрированы метрики Prometheus для мониторинга.
    *   *Описание:* Добавлены метрики `http_rate_limit_exceeded_total` и `http_rate_limit_blocked_total`.
*   **[US-API-RL-008]** Внедрено структурированное логирование событий ограничения запросов.
    *   *Описание:* Все события, связанные с rate limiting, теперь логируются в структурированном формате.
*   **[US-API-RL-009]** Реализован режим "fail-open" при недоступности Redis.
    *   *Описание:* Запросы разрешаются, если Redis недоступен, для предотвращения блокировки сервиса.
*   **[US-API-RL-010]** Добавлен резервный слой ограничения запросов на уровне Nginx.
    *   *Описание:* Nginx настроен для дополнительного ограничения запросов.

**Измененные файлы:**
*   `core/middleware/rate_limit.py` (НОВЫЙ)
*   `core/middleware/__init__.py` (ОБНОВЛЕН)
*   `app.py` (ОБНОВЛЕН - middleware зарегистрирован)
*   `.env.example` (ОБНОВЛЕН - конфигурация rate limit)
*   `tests/test_rate_limiting.py` (НОВЫЙ)

## Ссылки на Документацию

### FSD (Functional Specification Document)

*   (Если есть соответствующий FSD, добавить ссылку сюда)

### ADR (Architectural Decision Record)

*   (Если есть соответствующий ADR, добавить ссылку сюда)

### Guides (Руководства)

*   [Документация по фиче Rate Limiting](docs/features/rate_limiting.md)

### Docker

*   (Если были изменения в Docker-конфигурации, связанные с этим релизом, описать здесь)

### Yarn (или другие менеджеры пакетов)

*   (Если были изменения в зависимостях фронтенда, описать здесь)

### Другое

*   [Заметки CLAUDE](CLAUDE.md)
